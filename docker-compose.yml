services:
  qadir-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: qadir
      POSTGRES_USER: qadir
      POSTGRES_PASSWORD: ${DB_PASSWORD:-qadir_prod_2026}
    volumes:
      - qadir-pgdata:/var/lib/postgresql/data
    networks:
      - qadir-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qadir -d qadir"]
      interval: 10s
      timeout: 5s
      retries: 5

  qadir-api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    restart: unless-stopped
    depends_on:
      qadir-db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://qadir:${DB_PASSWORD:-qadir_prod_2026}@qadir-db:5432/qadir?schema=public
      PORT: "3001"
      CORS_ORIGIN: ${CORS_ORIGIN:-https://qadir.pixelcraftedmedia.com}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_REPLACE_ME}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_REPLACE_ME}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@qadir.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      SESSION_SECRET: ${SESSION_SECRET:-qadir-session-prod-secret-2026}
    networks:
      - qadir-internal
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.http.routers.qadir-api.rule=Host(`api-qadir.pixelcraftedmedia.com`)
      - traefik.http.routers.qadir-api.entrypoints=websecure
      - traefik.http.routers.qadir-api.tls.certresolver=letsencrypt
      - traefik.http.services.qadir-api.loadbalancer.server.port=3001
      - traefik.http.routers.qadir-api-http.rule=Host(`api-qadir.pixelcraftedmedia.com`)
      - traefik.http.routers.qadir-api-http.entrypoints=web
      - traefik.http.routers.qadir-api-http.middlewares=qadir-redirect-https
      - traefik.http.middlewares.qadir-redirect-https.redirectscheme.scheme=https

  qadir-web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api-qadir.pixelcraftedmedia.com/api/v1}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-https://qadir.pixelcraftedmedia.com}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-pk_test_REPLACE_ME}
    restart: unless-stopped
    depends_on:
      - qadir-api
    networks:
      - qadir-internal
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.http.routers.qadir-web.rule=Host(`qadir.pixelcraftedmedia.com`)
      - traefik.http.routers.qadir-web.entrypoints=websecure
      - traefik.http.routers.qadir-web.tls.certresolver=letsencrypt
      - traefik.http.services.qadir-web.loadbalancer.server.port=3000
      - traefik.http.routers.qadir-web-http.rule=Host(`qadir.pixelcraftedmedia.com`)
      - traefik.http.routers.qadir-web-http.entrypoints=web
      - traefik.http.routers.qadir-web-http.middlewares=qadir-redirect-https

volumes:
  qadir-pgdata:

networks:
  qadir-internal:
    driver: bridge
  dokploy-network:
    external: true
